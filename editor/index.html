<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Editor with Manix AI</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.10/codemirror.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.10/theme/dracula.min.css" rel="stylesheet">

    <style>
        body, html {
            background-color: #1a1a1a;
            height: 100%;
            margin: 0;
            overflow: hidden;
        }
        .list-group {
            cursor: pointer;
        }
        #editorSection {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 50%;
        }
        .CodeMirror {
            height: 100%;
            width: 100%;
            max-width: 100%;
            border: 1px solid #444;
            box-sizing: border-box;
            overflow: hidden;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        #editor-container {
            flex-grow: 1;
            overflow: hidden;
            max-width: 100%;
            display: flex;
            flex-direction: column;
        }
        #preview {
            height: 100%;
            max-width: 100%;
            overflow: auto;
            background-color: #fff;
            border: 1px solid #444;
        }
        .btn {
            font-size: 14px;
        }
        .resizable-divider {
            cursor: ew-resize;
            background-color: #6c757d;
            width: 8px;
            height: 100%;
            flex-shrink: 0;
        }
        #collapsibleSection {
            display: none;
            background-color: #2d2d2d;
            padding: 10px;
            border: 1px solid #444;
            overflow-y: auto;
            max-height: 100%;
            min-height: 50%;
            color: #fff;
        }
        .resizable {
            display: flex;
            width: 100%;
            height: 100%;
        }
        #editorSection, #previewSection {
            overflow: hidden;
        }
        #previewSection {
            width: 50%;
        }
        .fullscreen-editor {
            width: 100% !important;
            height: 100% !important;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 9999;
            background: #1e1e1e;
        }
        .fullscreen-editor #editorToolbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #333;
            z-index: 10000;
            display: flex;
            padding: 5px;
        }
        .fullscreen-editor #editor-container {
            margin-top: 40px;
        }
        #gemini-modal {
            color: #333;
        }
        .ai-button {
            background: linear-gradient(45deg, #6c5ce7, #a29bfe);
            border: none;
            color: white;
        }
        .ai-button:hover {
            background: linear-gradient(45deg, #5c4fc9, #8f86e5);
            color: white;
        }
        .gemini-output {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .api-key-container {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .modal-content {
            border: none;
            border-radius: 10px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.2);
        }
        .modal-header {
            background: linear-gradient(45deg, #6c5ce7, #a29bfe);
            color: white;
            border-radius: 10px 10px 0 0;
        }
        .btn-close {
            color: white;
        }
        #gemini-response {
            min-height: 100px;
            max-height: 200px;
            overflow-y: auto;
        }
        .spinner-border {
            width: 1.5rem;
            height: 1.5rem;
        }
        #editorToolbar {
            flex-wrap: wrap;
        }
        #editorToolbar .btn {
            margin-bottom: 5px;
        }
        .api-status {
            font-size: 0.9rem;
            margin-top: 5px;
        }
        .status-valid {
            color: #28a745;
        }
        .status-invalid {
            color: #dc3545;
        }
        .project-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #444;
        }
        .project-name {
            flex-grow: 1;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
        }
        .project-name:hover {
            background-color: #3d3d3d;
        }
        .project-actions {
            display: flex;
            gap: 5px;
        }
        .no-projects {
            padding: 15px;
            text-align: center;
            color: #888;
        }
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
<div class="container-fluid h-100">
    <div class="resizable">
        <!-- Editor Section -->
        <div id="editorSection" class="d-flex flex-column h-100">
            <div id="editorToolbar" class="btn-group p-2">
                <button id="runButton" class="btn btn-primary">Run</button>
                <button id="revertButton" class="btn btn-secondary">Revert</button>
                <button onclick="openTemplates()" class="btn btn-secondary">Templates</button>
                <button id="openPreviewButton" class="btn btn-warning">Preview</button>
                <button id="toggleSavedStates" class="btn btn-danger">Save/Projects</button>
                <button id="newButton" class="btn btn-success">New</button>
                <button id="fullscreenEditorButton" class="btn btn-secondary">Full-Screen</button>
                <button id="geminiButton" class="btn ai-button">Manix AI</button>
            </div>
            <div id="collapsibleSection">
                <div class="form-group">
                    <label for="stateName">Save project</label>
                    <input type="text" id="stateName" class="form-control" placeholder="Enter project name">
                    <button id="saveButton" class="btn btn-success mt-2">Save</button>
                    <button id="toggleSavedStates2" class="btn btn-outline-secondary mt-2">Cancel</button>
                </div>
                <h5>Saved Projects:</h5>
                <div id="stateList" class="list-group"></div>
                <br>
                <button id="toggleSavedStates3" class="btn btn-danger" style="float:right;">Close</button>
            </div>
            <div id="editor-container"></div>
        </div>
        <!-- Resizable Divider -->
        <div id="divider" class="resizable-divider"></div>
        <!-- Preview Section -->
        <div id="previewSection">
            <iframe id="preview" class="w-100"></iframe>
        </div>
    </div>
</div>

<!-- Gemini AI Modal -->
<div class="modal fade" id="gemini-modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Manix AI Code Assistant</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
            
                <div class="api-key-container">
                    <div class="form-group">
                        <label for="api-key">Manix API Key: AIzaSyBt02sF2fwoJZKCa8QahJgKUkSMF5Nq4J4</label>
                        <input type="password" class="form-control" id="api-key" placeholder="Enter your Manix API key">
                        <small class="form-text text-muted">Your API key is stored locally in your browser and only sent to Manix's servers.</small>
                        <div id="api-status" class="api-status"></div>
                    </div>
                    <button id="save-api-key" class="btn btn-primary">Save API Key</button>
                    <button id="validate-api-key" class="btn btn-info">Validate Key</button>
                </div>
               
                
                <div class="form-group mt-3">
                    <label for="ai-prompt">What would you like to change in your code?</label>
                    <textarea class="form-control" id="ai-prompt" rows="3" placeholder="E.g., 'Add a responsive navigation bar' or 'Fix the layout on mobile devices'"></textarea>
                </div>
                
                <button id="send-to-gemini" class="btn ai-button mt-3">
                    <span id="gemini-button-text">Send to Manix</span>
                    <span id="gemini-spinner" class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
                </button>
                
                <div class="gemini-output mt-3">
                    <strong>Response:</strong>
                    <div id="gemini-response">Your response will appear here...</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button id="apply-changes" class="btn btn-primary" disabled>Apply Changes</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.10/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.10/mode/xml/xml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.10/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.10/mode/css/css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.10/mode/htmlmixed/htmlmixed.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.10/addon/edit/closetag.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.10/addon/edit/matchbrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Constants
    const STORAGE_KEY = 'editorContent';
    const SAVED_STATES_KEY = 'savedStates';
    const GEMINI_API_KEY = 'geminiApiKey';
    const DEFAULT_CONTENT = `<!DOCTYPE html>
<html>
<head>
    <title>Preview</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
            background-color: #f4f4f4;
        }
        h1 {
            color: #333;
        }
    </style>
</head>
<body>
    <h1>Hello, World!</h1>
    <p>Start editing your code here or ask Manix AI for help! or <a href="https://manixai.com/editor/templates/"> Start with a template!</a></p>
</body>
</html>`;

    // Initialize editor
    const editor = CodeMirror(document.getElementById('editor-container'), {
        value: localStorage.getItem(STORAGE_KEY) || DEFAULT_CONTENT,
        mode: 'htmlmixed',
        theme: 'dracula',
        lineNumbers: true,
        lineWrapping: true,
        autoCloseTags: true,
        matchBrackets: true,
    });

    const preview = document.getElementById('preview');
    const stateNameInput = document.getElementById('stateName');
    const stateList = document.getElementById('stateList');
    const collapsibleSection = document.getElementById('collapsibleSection');
    
    // Initialize preview with current content
    updatePreview(editor.getValue());

    // Update Preview
    function updatePreview(content) {
        const doc = preview.contentDocument || preview.contentWindow.document;
        doc.open();
        doc.write(content);
        doc.close();
    }

    // Event listeners for existing functionality
    document.getElementById('runButton').addEventListener('click', () => {
        const content = editor.getValue();
        localStorage.setItem(STORAGE_KEY, content);
        updatePreview(content);
    });

    document.getElementById('saveButton').addEventListener('click', () => {
        const stateName = stateNameInput.value.trim();
        if (!stateName) return alert('Enter a name for the project.');

        const savedStates = JSON.parse(localStorage.getItem(SAVED_STATES_KEY)) || [];
        savedStates.push({ name: stateName, content: editor.getValue() });
        localStorage.setItem(SAVED_STATES_KEY, JSON.stringify(savedStates));
        renderSavedStates();
        stateNameInput.value = '';
    });

    document.getElementById('revertButton').addEventListener('click', () => {
        const savedState = localStorage.getItem(STORAGE_KEY);
        if (savedState) {
            editor.setValue(savedState);
            updatePreview(savedState);
        } else {
            alert('No saved state to revert to.');
        }
    });

    document.getElementById('toggleSavedStates').addEventListener('click', () => {
        collapsibleSection.style.display = collapsibleSection.style.display === 'none' ? 'block' : 'none';
    });
    
    document.getElementById('toggleSavedStates2').addEventListener('click', () => {
        collapsibleSection.style.display = 'none';
    });
    
    document.getElementById('toggleSavedStates3').addEventListener('click', () => {
        collapsibleSection.style.display = 'none';
    });

    document.getElementById('openPreviewButton').addEventListener('click', () => {
        const newWindow = window.open('', '_blank', 'width=800,height=600');
        if (newWindow) {
            newWindow.document.write(editor.getValue());
            newWindow.document.close();
        } else {
            alert('Unable to open preview window. Check your browser settings.');
        }
    });

    document.getElementById('newButton').addEventListener('click', () => {
        if (confirm('Create a new file? Any unsaved changes will be lost.')) {
            editor.setValue(DEFAULT_CONTENT);
            updatePreview(DEFAULT_CONTENT);
            localStorage.removeItem(STORAGE_KEY);
        }
    });

    document.getElementById('fullscreenEditorButton').addEventListener('click', () => {
        const editorSection = document.getElementById('editorSection');
        if (editorSection.classList.contains('fullscreen-editor')) {
            editorSection.classList.remove('fullscreen-editor');
            document.body.style.overflow = '';
            document.getElementById('fullscreenEditorButton').textContent = 'Full-Screen';
        } else {
            editorSection.classList.add('fullscreen-editor');
            document.body.style.overflow = 'hidden';
            document.getElementById('fullscreenEditorButton').textContent = 'Exit Full-Screen';
        }
        editor.refresh();
    });

    function renderSavedStates() {
        const savedStates = JSON.parse(localStorage.getItem(SAVED_STATES_KEY)) || [];
        stateList.innerHTML = '';
        
        if (savedStates.length === 0) {
            stateList.innerHTML = '<div class="no-projects">No projects saved yet</div>';
            return;
        }
        
        savedStates.forEach((state, index) => {
            const projectItem = document.createElement('div');
            projectItem.className = 'project-item';
            
            const projectName = document.createElement('div');
            projectName.className = 'project-name';
            projectName.textContent = state.name;
            projectName.addEventListener('click', () => {
                editor.setValue(state.content);
                updatePreview(state.content);
                localStorage.setItem(STORAGE_KEY, state.content);
                collapsibleSection.style.display = 'none';
            });
            
            const projectActions = document.createElement('div');
            projectActions.className = 'project-actions';
            
            const renameBtn = document.createElement('button');
            renameBtn.textContent = 'Rename';
            renameBtn.className = 'btn btn-sm btn-info';
            renameBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const newName = prompt('Enter new name:', state.name);
                if (newName) {
                    state.name = newName;
                    localStorage.setItem(SAVED_STATES_KEY, JSON.stringify(savedStates));
                    renderSavedStates();
                }
            });

            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Delete';
            deleteBtn.className = 'btn btn-sm btn-danger';
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (confirm(`Delete project: "${state.name}"?`)) {
                    savedStates.splice(index, 1);
                    localStorage.setItem(SAVED_STATES_KEY, JSON.stringify(savedStates));
                    renderSavedStates();
                }
            });
            
            projectActions.appendChild(renameBtn);
            projectActions.appendChild(deleteBtn);
            
            projectItem.appendChild(projectName);
            projectItem.appendChild(projectActions);
            
            stateList.appendChild(projectItem);
        });
    }

    // Render Saved States
    renderSavedStates();

    // Resizable divider functionality
    const divider = document.getElementById('divider');
    const editorSection = document.getElementById('editorSection');
    const previewSection = document.getElementById('previewSection');
    let isResizing = false;

    divider.addEventListener('mousedown', (e) => {
        isResizing = true;
        document.body.style.cursor = 'ew-resize';
        document.addEventListener('mousemove', handleResize);
        document.addEventListener('mouseup', stopResize);
    });

    function handleResize(e) {
        if (!isResizing) return;

        const containerWidth = divider.parentElement.offsetWidth;
        const newEditorWidth = e.clientX;
        const newPreviewWidth = containerWidth - e.clientX - divider.offsetWidth;

        const minWidth = 150;
        if (newEditorWidth >= minWidth && newPreviewWidth >= minWidth) {
            editorSection.style.width = `${newEditorWidth}px`;
            previewSection.style.width = `${newPreviewWidth}px`;
        }
    }

    function stopResize() {
        if (!isResizing) return;

        isResizing = false;
        document.body.style.cursor = 'auto';
        document.removeEventListener('mousemove', handleResize);
        document.removeEventListener('mouseup', stopResize);
    }

    // Gemini AI functionality
    const geminiModal = new bootstrap.Modal(document.getElementById('gemini-modal'));
    const apiKeyInput = document.getElementById('api-key');
    const saveApiKeyButton = document.getElementById('save-api-key');
    const validateApiKeyButton = document.getElementById('validate-api-key');
    const sendToGeminiButton = document.getElementById('send-to-gemini');
    const geminiSpinner = document.getElementById('gemini-spinner');
    const geminiButtonText = document.getElementById('gemini-button-text');
    const geminiResponse = document.getElementById('gemini-response');
    const applyChangesButton = document.getElementById('apply-changes');
    const aiPromptInput = document.getElementById('ai-prompt');
    const apiStatus = document.getElementById('api-status');

    // Load saved API key if exists
    const savedApiKey = localStorage.getItem(GEMINI_API_KEY);
    if (savedApiKey) {
        apiKeyInput.value = savedApiKey;
        apiStatus.textContent = 'API key loaded from storage';
        apiStatus.className = 'api-status status-valid';
    }

    document.getElementById('geminiButton').addEventListener('click', () => {
        geminiModal.show();
    });

    saveApiKeyButton.addEventListener('click', () => {
        const apiKey = apiKeyInput.value.trim();
        if (apiKey) {
            localStorage.setItem(GEMINI_API_KEY, apiKey);
            apiStatus.textContent = 'API key saved successfully!';
            apiStatus.className = 'api-status status-valid';
        } else {
            apiStatus.textContent = 'Please enter a valid API key.';
            apiStatus.className = 'api-status status-invalid';
        }
    });

    validateApiKeyButton.addEventListener('click', async () => {
        const apiKey = apiKeyInput.value.trim();
        if (!apiKey) {
            apiStatus.textContent = 'Please enter an API key first.';
            apiStatus.className = 'api-status status-invalid';
            return;
        }

        validateApiKeyButton.disabled = true;
        validateApiKeyButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Validating...';

        try {
            const isValid = await validateGeminiApiKey(apiKey);
            if (isValid) {
                apiStatus.textContent = 'API key is valid!';
                apiStatus.className = 'api-status status-valid';
                localStorage.setItem(GEMINI_API_KEY, apiKey);
            } else {
                apiStatus.textContent = 'API key is invalid. Please check and try again.';
                apiStatus.className = 'api-status status-invalid';
            }
        } catch (error) {
            apiStatus.textContent = 'Error validating API key: ' + error.message;
            apiStatus.className = 'api-status status-invalid';
        } finally {
            validateApiKeyButton.disabled = false;
            validateApiKeyButton.textContent = 'Validate Key';
        }
    });

    sendToGeminiButton.addEventListener('click', async () => {
        const apiKey = apiKeyInput.value.trim();
        const prompt = aiPromptInput.value.trim();
        
        if (!apiKey) {
            apiStatus.textContent = 'Please enter your Manix API key first.';
            apiStatus.className = 'api-status status-invalid';
            return;
        }
        
        if (!prompt) {
            alert('Please enter a prompt for Manix.');
            return;
        }
        
        // Show loading state
        geminiSpinner.style.display = 'inline-block';
        geminiButtonText.textContent = 'Processing...';
        sendToGeminiButton.disabled = true;
        
        geminiResponse.textContent = 'Contacting Manix AI...';
        
        try {
            // Call the real Gemini API
            const response = await callGeminiAPI(apiKey, editor.getValue(), prompt);
            
            // Display the response
            geminiResponse.textContent = response;
            
            // Enable apply button
            applyChangesButton.disabled = false;
        } catch (error) {
            geminiResponse.textContent = `Error: ${error.message}`;
            console.error('Manix API error:', error);
        } finally {
            // Restore button state
            geminiSpinner.style.display = 'none';
            geminiButtonText.textContent = 'Send to Manix';
            sendToGeminiButton.disabled = false;
        }
    });

    applyChangesButton.addEventListener('click', () => {
    let modifiedCode = geminiResponse.textContent;
    
    // Remove Markdown code block indicators if present
    if (modifiedCode.startsWith('```html')) {
        modifiedCode = modifiedCode.replace(/^```html\s*/, '').replace(/\s*```$/, '');
    }
    
    if (modifiedCode && !modifiedCode.includes('Error:')) {
        editor.setValue(modifiedCode);
        updatePreview(modifiedCode);
        localStorage.setItem(STORAGE_KEY, modifiedCode);
        geminiModal.hide();
    }
});

    // Validate Gemini API Key
    async function validateGeminiApiKey(apiKey) {
        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: "Hello"
                        }]
                    }]
                })
            });
            
            if (response.status === 200) {
                return true;
            } else if (response.status === 400) {
                // This might be a invalid request but API key is valid
                const data = await response.json();
                if (data.error && data.error.message) {
                    // If the error is about content, the API key is likely valid
                    return data.error.message.includes('content');
                }
                return false;
            } else if (response.status === 403) {
                // API key is invalid
                return false;
            }
            return false;
        } catch (error) {
            console.error('API key validation error:', error);
            return false;
        }
    }

    // Call the real Gemini API
    async function callGeminiAPI(apiKey, code, prompt) {
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
        
        const fullPrompt = `you are manix ai. You are an expert web developer. Please help me modify this HTML code based on the following request: ${prompt}. 
        
Here is the current code:
${code}

Please return ONLY the complete modified code without any additional explanation or commentary.`;

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: fullPrompt
                        }]
                    }],
                    generationConfig: {
                        temperature: 0.7,
                        topK: 40,
                        topP: 0.95,
                        maxOutputTokens: 2048,
                    }
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || `API error: ${response.status}`);
            }
            
            const data = await response.json();
            
            // Extract the response text
            if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts) {
                return data.candidates[0].content.parts[0].text;
            } else {
                throw new Error('Unexpected response format from Manix API');
            }
        } catch (error) {
            console.error('Error calling Manix API:', error);
            throw new Error(`Failed to call Manix API: ${error.message}`);
        }
    }

   

    // Template function
    function openTemplates() {
        window.open("https://bootsnipp.com", "_blank", "toolbar=yes,scrollbars=yes,resizable=yes,top=200,left=200,width=1000,height=900");
    }
</script>
</body>
</html>
